# ADR-0003 Технологический стек Backend веб-приложения для ФС

Date: 2025-02-22

## Status
Canceled

## Критический сценарий:
* С помощью веб-приложения подбора оптимальной конфигурации лестницы, пользователь получает набор оптимальных конфигураций лестницы в режиме онлайн. На время ожидания подбора пользователь видит прогресс выполнения процесса подбора конфигураций.

## Критические характеристики:
* Время подбора оптимальных конфигураций лестниц для одного проема не более 1 минуты.

### Контекст
Для реализации функционала подбора оптимальных конфигураций лестницы требуется разработать backend-приложение, способное выполнять подбор подходящих вариантов лестниц любой возможной конфигурации за промежуток времени не более 1 минуты. Архитектура приложения должна:
* Учитывать ограничение ко времени подбора конфигураций лестниц;
* Легко масштабироваться;
* Отвечать архитектурному стилю REST API;
* CORS для предоставления API разным доменам проекта Kalk.Pro;
* Поддерживать совместимость с легаси наследием проекта Kalk.Pro;
* Учитывать планы на рефакторинг ФС Кластера проектных расчетов.

### Артефакты системной архитектуры
![Контекст программных систем ландшафта онлайн-сервиса Kalk.Pro](/docs/c4/models/structurizr-1-systemLandscape.svg)
![L1: Контекст программных систем ФС Кластер проектных расчетов](/docs/c4/models/node-calc/structurizr-1-NODE_CALC_C4L1.svg)
![L2: Контейнеры ФС Кластер проектных расчетов](/docs/c4/models/node-calc/structurizr-1-NODE_CALC_C4L2.svg)
![Схема развертывания Development ФС Кластер проектных расчетов](/docs/c4/models/node-calc/structurizr-1-NODE_CALC_DEPLOY_DEV.svg)
![Схема развертывания Production ФС Кластер проектных расчетов](/docs/c4/models/node-calc/structurizr-1-NODE_CALC_DEPLOY_PROD.svg)

### Рассматриваемые варианты решения
#### Backend-приложение как новый сервис в ФС Кластера проектных расчётов
Данный подход позволяет использовать инфраструктуру ФС Кластера проектных расчетов для разработки приложения в виде дополнительного сервиса. В качестве транспорта взаимодействия между frontend и backend будет использоваться Web-Socket AsyncApi. Данный транспорт уже используется на сайте онлайн-сервиса, что позволяет произвести простую интеграцию с существующим легаси кодом проекта.
##### Плюсы решения
* Быстрая разработка приложения за счет использования существующей инфраструктуры ФС Кластера проектных расчетов;
* Полная совместимость с легаси "наследием" проекта Kalk.Pro;
* Возможность масштабирования вычислительной мощности приложения за счет запуска дополнительных инстансов приложения, в том числе на дополнительных серверах;
* CORS за счет использования Web-Socket для работы frontend с серверным приложением.
##### Минусы решения
* Ограничение на выбор языка разработки стеком ФС Кластера проектных расчетов - NodeJS;
* Отсутствие штатного качественного мониторинга приложения и управление его состоянием;
* Отсутствие возможности автоматического масштабирования приложения в зависимости от нагрузки и заданных НФТ. Подобный функционал потребует разработки дополнительного ответственного сервиса в контексте ФС Кластера проектных расчетов;
* Неформализованный AsyncApi продиктованный легаси "наследием" проекта.

#### Backend-приложение в Kubernetes
Данный подход позволяет использовать множество инфраструктурных компонентов Kubernetes для автоматического масштабирования приложения, отслеживания его состояния, отправки уведомлений и логирования состояния. Серверное приложение в виде микросервиса. Обмен между frontend веб-приложением и backend - REST API для инициирования подбора оптимальных конфигурации лестниц. SSE для уведомления frontend веб-приложения о состоянии подбора ("в очереди", "прогресс выполнения", "результат").
##### Плюсы решения
* Нет ограничений на выбор языка для разработки приложения;
* Возможность автоматического масштабирования приложения под нагрузкой;
* Возможность использование инфраструктурных систем мониторинга, алертинга и логирования (Prometheus, Grafana, Kibana);
* Возможность использование формализованной REST API архитектуры.
* Создание инфраструктуры в Kubernetes для будущего рефакторинга ФС Кластера проектных расчетов: разделение сервисов на "настоящие" микросервисы.
##### Минусы решения
* Значительное увеличение времени разработки приложения в сравнении с вариантом разработки нового сервиса в ФС Кластера проектных расчетов.
* Дополнительные затраты на создание и поддержку инфраструктуры в Kubernetes;
* Затраты на обучение сотрудников технического сопровождения проекта для работы с инфраструктурой Kubernetes.

#### Комбинированный вариант (backend-приложение в Kubernetes с "проксированием" запроса через сервис в Кластере проектных расчетов)
Вариант архитектуры, когда за взаимодействие frontend-приложения с backend-приложением будет отвечать сервис в контексте ФС Кластер проектных расчетов, который через Web-Socket реализует двухсторонний обмен о состоянии и результатах подбора оптимальных конфигураций. При этом само приложение подбора оптимальных конфигураций лестниц находится вне ФС Кластер проектных расчетов в инфраструктуре Kubernetes на отдельной ноде. С учётом будущего перевода всех сервисов ФС Кластер проектных расчетов на микро-сервисную архитектуру с формализованным REST API, backend-приложение подбора оптимальных конфигураций реализует REST API интерфейс, который транспонируется в AsyncAPI запросы в ФС Кластер проектных расчетов, тем самым реализуя совместимость с текущим легаси сервиса Kalk.Pro, и может быть отделено при рефакторинге и переходе на REST.

##### Плюсы решения
* Быстрая разработка приложения за счет использования существующей инфраструктуры ФС Кластера проектных расчетов;
* Полная совместимость с легаси "наследием" проекта Kalk.Pro;
* Возможность масштабирования вычислительной мощности приложения за счет запуска дополнительных инстансов приложения, в том числе на дополнительных серверах;
* CORS за счет использования Web-Socket для работы frontend с серверным приложением.
* Нет ограничений на выбор языка для разработки приложения подбора оптимальных конфигураций;
* Возможность автоматического масштабирования приложения под нагрузкой;
* Возможность использование инфраструктурных систем мониторинга, алертинга и логирования (Prometheus, Grafana, Kibana);
* Возможность использование формализованной REST API архитектуры.
* Создание инфраструктуры в Kubernetes для будущего рефакторинга ФС Кластера проектных расчетов: разделение сервисов на "настоящие" микросервисы.
##### Минусы решения
* Значительное увеличение времени на разработку, так как потребуется разработать не только приложение подбора оптимальных конфигураций, но и дополнительный сервис(ы) для проксирования и транспонирования REST запросов через Web-Socket в контексте ФС Кластера проектных расчетов.
* Неформализованный AsyncApi продиктованный легаси "наследием" проекта.
* Дополнительные затраты на создание и поддержку инфраструктуры в Kubernetes;
* Дополнительные затраты на создание и поддержку новых сервисов в ФС Кластера проектных расчетов;
* Затраты на обучение сотрудников технического сопровождения проекта для работы с инфраструктурой Kubernetes.
* Увеличение количество точек отказа в силу наличия промежуточного слоя в виде сервисов для проксирования и транспонирования REST запросов через Web-Socket в контексте ФС Кластера проектных расчетов.
* Усложнение архитектуры.

### Принятое решение
Использовать комбинированный вариант серверного приложения подбора оптимальных конфигураций: backend-приложение в Kubernetes

### Последствия
* Совместимость с легаси архитектурой проекта Kalk.Pro
* Использование инфраструктуры для будущего перехода на полностью микро-сервисную архитектуру.
* Возможность автоматического масштабирования приложения для выполнения НФТ.
* Широкий набор инструментов для контроля и наблюдаемости работы приложения средствами Kubernetes.

### Риски
* **Высокий порог входа**: Команде потребуется обучение для работы с Kubernetes
* **Увеличение сложности архитектуры**: Kubernetes добавляет новый уровень абстракции. В комбинации с проксирующими сервисами в ФС Кластере проектных расчетов, приводит к сильному усложнению системы.
* **Увеличение сроков разработки**. Потребуется разработка дополнительных сервисов в ФС Кластере проектных расчетов и самого приложения расчёта оптимальных конфигураций.
* **Удорожание разработки**. Требуется привлечение большего количества разработчиков. Увеличение издержек на интеграционное тестирование и поддержку.

### Митигация рисков
* Разработать план обучения для команды разработчиков технического сопровождения проекта.
* Создать детальную документацию по настройке и эксплуатации Kubernetes-кластера.
* Для соблюдения сроков реализации привлечь к разработке две команды разработчиков, работающих параллельно: одна над частью проксирующих сервисов в ФС Кластера проектных расчетов, вторая над приложением подбора оптимальных конфигураций.

# Спецификации OpenAPI и AsyncAPI backend-приложения
* [Optistairs - Сервис подбора оптимальных конфигураций лестницы OpenAPI](openapi/optistairs-restapi.yaml)
* [Router AsyncAPI](openapi/router-asyncapi.yaml)
* [WebHookListener AsyncAPI](openapi/WebHookListener-asyncapi.yaml)
* [WebHookListener OpenAPI](openapi/WebHookListener-restapi.yaml)


[> На главную страницу](/README.md)